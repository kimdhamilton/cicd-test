name: Publish minutes

on:
  push:
    paths:
    - '**/irc.log'

jobs:
  generate-html:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node-version }}
    - name: Setup custom environment variables
      run: git config --global push.default simple && git config --global user.email "w3c.ccg@gmail.com" && git config --global user.name "W3C CCG"
    - name: Generate html minutes
      id: generate_html_minutes
      run: |
        npm install
        bash ./generate-html.sh
        echo "##[set-output name=date;]${DATE}"
      env:
        CI: true
        DATE: "2020-01-21"
        
    - uses: stefanzweifel/git-auto-commit-action@v2.5.0
      with:
        commit_message: Add html minutes for telecon [ci skip]
        branch: master

        # Optional git params
        #commit_options: '--no-verify --signoff'

        # Optional glob pattern of files which should be added to the commit
        #file_pattern: index.html

      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Send email
      uses: dawidd6/action-send-mail@v1.3.0
   
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: w3c.ccg
        password: ${{ secrets.password }}
        subject: ${{ format('[MINUTES] W3C Credentials CG Call - {0} 12pm ET', steps.generate_html_minutes.outputs.date) }}
        body: ${{ format('file://{0}/email.log', steps.generate_html_minutes.outputs.date) }}
        to: w3c.ccg+123@gmail.com
        from: w3c.ccg@gmail.com
        #content_type: # optional, default is text/plain
          
    - name: Twitter Action
      uses: xorilog/twitter-action@0.1
      with:
        MESSAGE: ${{ format('Credentials CG Minutes Available https://w3c-ccg.github.io/meetings/{0} #w3c #ccg', steps.generate_html_minutes.outputs.date) }}
        TWITTER_CONSUMER_KEY: ${{ secrets.twitter_api_key }}
        TWITTER_CONSUMER_SECRET: ${{ secrets.twitter_api_secret }}
        TWITTER_ACCESS_TOKEN: ${{ secrets.twitter_access_token }}
        TWITTER_ACCESS_SECRET:  ${{ secrets.twitter_access_token_secret }}
